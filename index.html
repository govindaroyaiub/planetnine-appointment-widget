<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website with Chat Agent</title>
    <style>
        /* Basic page styling */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        .main-content {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Chat widget styles */
        .chat-widget {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }

        .chat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            border: none;
        }

        .chat-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .chat-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .chat-box {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.9);
            transition: all 0.3s ease;
            border: 1px solid #e1e5e9;
        }

        .chat-box.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .header-title {
            font-size: 16px;
            margin: 0;
        }

        .netherlands-time {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 400;
            margin-top: 2px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .chat-content {
            padding: 20px;
        }

        .chat-message {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.4;
            color: #333;
        }

        .chat-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #495057;
        }

        .btn-primary:disabled,
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading state */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Success/Error messages */
        .status-message {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Status styling when applied directly to chat-message */
        .chat-message.status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .chat-message.status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Name input form styles */
        .name-input-form {
            display: none;
            margin-top: 16px;
        }

        .name-input-form.active {
            display: block;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .name-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .message-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .message-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 8px;
        }

        .form-buttons .chat-btn {
            flex: 1;
        }
    </style>
</head>

<body>
    <!-- Main page content -->
    <div class="main-content">
        <h1>Welcome to Our Website</h1>
        <p>This is a sample website with a chat widget in the bottom right corner. You can book appointments or get help
            using the chat feature.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore
            magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
            commodo consequat.</p>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <!-- Chat Icon -->
        <button class="chat-icon" id="chatIcon">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12,3C6.5,3 2,6.58 2,11C2,13.78 3.61,16.21 6,17.69L5,21L9.5,19C10.25,19.05 11,19.05 12,19C17.5,19 22,15.42 22,11C22,6.58 17.5,3 12,3M12,17C11.18,17 10.37,16.95 9.6,16.76L7.5,17.5L8.13,15.83C6.24,14.7 5,12.95 5,11C5,8.24 8.13,6 12,6C15.87,6 19,8.24 19,11C19,13.76 15.87,16 12,16L12,17Z" />
            </svg>
        </button>

        <!-- Chat Box -->
        <div class="chat-box" id="chatBox">
            <div class="chat-header">
                <div class="header-content">
                    <div class="header-title">How can we help?</div>
                    <div class="netherlands-time" id="netherlandsTime">Netherlands: --:-- --</div>
                </div>
                <button class="close-btn" id="closeBtn">&times;</button>
            </div>
            <div class="chat-content">
                <div class="chat-message" id="welcomeMessage">
                    Hello! Welcome to our website. How can we assist you today?
                </div>
                <div class="chat-buttons">
                    <button class="chat-btn btn-primary" id="bookBtn">
                        Book an Appointment
                    </button>
                    <button class="chat-btn btn-secondary" id="cancelBtn">
                        Cancel
                    </button>
                </div>

                <!-- Name input form (hidden initially) -->
                <div class="name-input-form" id="nameInputForm">
                    <div class="input-group">
                        <label class="input-label" for="customerName">Name:</label>
                        <input type="text" class="name-input" id="customerName" placeholder="Your full name" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="customerOrganization">Organization:</label>
                        <input type="text" class="name-input" id="customerOrganization" placeholder="Your organization"
                            required>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="customerEmail">Email:</label>
                        <input type="email" class="name-input" id="customerEmail" placeholder="your.email@example.com"
                            required>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="customerMessage">Booking Time & Date:</label>
                        <textarea class="message-textarea" id="customerMessage"
                            placeholder="Example: today at 3 pm or tomorrow at 2 pm" rows="3"></textarea>
                    </div>
                    <div class="form-buttons">
                        <button class="chat-btn btn-primary" id="submitBtn">
                            Submit
                        </button>
                        <button class="chat-btn btn-secondary" id="backBtn">
                            Back
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chat widget functionality
        class ChatWidget {
            constructor() {
                this.chatIcon = document.getElementById('chatIcon');
                this.chatBox = document.getElementById('chatBox');
                this.closeBtn = document.getElementById('closeBtn');
                this.bookBtn = document.getElementById('bookBtn');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.welcomeMessage = document.getElementById('welcomeMessage');
                this.nameInputForm = document.getElementById('nameInputForm');
                this.customerNameInput = document.getElementById('customerName');
                this.customerOrganizationInput = document.getElementById('customerOrganization');
                this.customerEmailInput = document.getElementById('customerEmail');
                this.customerMessageInput = document.getElementById('customerMessage');
                this.submitBtn = document.getElementById('submitBtn');
                this.backBtn = document.getElementById('backBtn');
                this.chatButtons = document.querySelector('.chat-buttons');
                this.netherlandsTimeEl = document.getElementById('netherlandsTime');

                // Initialize country as unknown, will be detected
                this.userCountry = 'Unknown';

                this.init();
                this.detectCountry();
                this.startNetherlandsTimeUpdates();
            }

            init() {
                // Event listeners
                this.chatIcon.addEventListener('click', () => this.toggleChat());
                this.closeBtn.addEventListener('click', () => this.closeChat());
                this.bookBtn.addEventListener('click', () => this.showNameInput());
                this.cancelBtn.addEventListener('click', () => this.closeChat());
                this.submitBtn.addEventListener('click', () => this.submitBooking());
                this.backBtn.addEventListener('click', () => this.showInitialButtons());

                // Handle Enter key in all input fields
                [this.customerNameInput, this.customerOrganizationInput, this.customerEmailInput].forEach(input => {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.submitBooking();
                        }
                    });
                });

                // Handle Ctrl+Enter in message textarea
                this.customerMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.submitBooking();
                    }
                });

                // Close chat when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.chat-widget') && this.chatBox.classList.contains('active')) {
                        this.closeChat();
                    }
                });
            }

            toggleChat() {
                this.chatBox.classList.toggle('active');
                if (this.chatBox.classList.contains('active')) {
                    this.clearStatus();
                }
            }

            closeChat() {
                this.chatBox.classList.remove('active');
                this.showInitialButtons();
                this.clearStatus();
                this.customerNameInput.value = '';
                this.customerOrganizationInput.value = '';
                this.customerEmailInput.value = '';
                this.customerMessageInput.value = '';
            }

            async detectCountry() {
                try {
                    // Using a CORS-friendly IP geolocation service
                    const response = await fetch('https://api.country.is/');
                    if (response.ok) {
                        const data = await response.json();
                        this.userCountry = data.country || 'Unknown';
                        console.log('Detected country:', this.userCountry);
                        return;
                    }
                } catch (error) {
                    console.log('Primary country detection failed:', error);
                }

                // Fallback 1: Try another service
                try {
                    const response = await fetch('https://ipinfo.io/json?token=');
                    if (response.ok) {
                        const data = await response.json();
                        this.userCountry = data.country || 'Unknown';
                        console.log('Detected country (fallback):', this.userCountry);
                        return;
                    }
                } catch (error) {
                    console.log('Fallback country detection failed:', error);
                }

                // Fallback 2: Use timezone-based detection
                try {
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    // Extract likely country from timezone
                    const timezoneCountryMap = {
                        'America/New_York': 'United States',
                        'America/Los_Angeles': 'United States',
                        'America/Chicago': 'United States',
                        'America/Denver': 'United States',
                        'Europe/London': 'United Kingdom',
                        'Europe/Paris': 'France',
                        'Europe/Berlin': 'Germany',
                        'Europe/Rome': 'Italy',
                        'Europe/Madrid': 'Spain',
                        'Asia/Tokyo': 'Japan',
                        'Asia/Shanghai': 'China',
                        'Asia/Kolkata': 'India',
                        'Australia/Sydney': 'Australia',
                        'America/Toronto': 'Canada',
                        'America/Mexico_City': 'Mexico'
                    };

                    this.userCountry = timezoneCountryMap[timezone] || `Timezone: ${timezone}`;
                    console.log('Detected country from timezone:', this.userCountry);
                } catch (tzError) {
                    console.log('Timezone detection failed:', tzError);
                    this.userCountry = 'Unknown';
                }
            }

            startNetherlandsTimeUpdates() {
                // Update immediately
                this.updateNetherlandsTime();

                // Update every second
                this.timeInterval = setInterval(() => {
                    this.updateNetherlandsTime();
                }, 1000);
            }

            updateNetherlandsTime() {
                const now = new Date();
                const options = {
                    timeZone: 'Europe/Amsterdam',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                };

                const netherlandsTime = now.toLocaleString('en-US', options);
                this.netherlandsTimeEl.textContent = `Netherlands: ${netherlandsTime}`;
            }

            showNameInput() {
                this.chatButtons.style.display = 'none';
                this.nameInputForm.classList.add('active');
                this.customerNameInput.focus();
                this.clearStatus();
            }

            showInitialButtons() {
                this.chatButtons.style.display = 'flex';
                this.nameInputForm.classList.remove('active');
                this.clearStatus();
            }

            async submitBooking() {
                const customerName = this.customerNameInput.value.trim();
                const customerOrganization = this.customerOrganizationInput.value.trim();
                const customerEmail = this.customerEmailInput.value.trim();
                const customerMessage = this.customerMessageInput.value.trim();

                // Validate all fields
                if (!customerName) {
                    this.showStatus('Please enter your name to continue.', 'error');
                    this.customerNameInput.focus();
                    return;
                }

                if (!customerOrganization) {
                    this.showStatus('Please enter your organization to continue.', 'error');
                    this.customerOrganizationInput.focus();
                    return;
                }

                if (!customerEmail) {
                    this.showStatus('Please enter your email to continue.', 'error');
                    this.customerEmailInput.focus();
                    return;
                }

                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(customerEmail)) {
                    this.showStatus('Please enter a valid email address.', 'error');
                    this.customerEmailInput.focus();
                    return;
                }

                // Disable button and show loading
                this.submitBtn.disabled = true;
                this.submitBtn.innerHTML = '<span class="loading"></span>Submitting...';
                this.clearStatus();

                try {
                    // Make POST request to book appointment
                    // const response = await fetch('https://tacostomps.app.n8n.cloud/webhook-test/084a116f-17ce-4040-8040-34a648db0edf', {
                        const response = await fetch('https://tacostomps.app.n8n.cloud/webhook/084a116f-17ce-4040-8040-34a648db0edf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            customerName: customerName,
                            customerOrganization: customerOrganization,
                            customerEmail: customerEmail,
                            customerMessage: customerMessage,
                            country: this.userCountry,
                            timestamp: new Date().toISOString(),
                            source: 'chat-widget'
                        })
                    });

                    if (response.ok) {
                        this.showStatus(`Thank you ${customerName}! Your booking is confirmed. Please check your email.`, 'success');

                        // Auto-close after 4 seconds
                        setTimeout(() => {
                            this.closeChat();
                        }, 4000);
                    } else {
                        this.showStatus(`Sorry ${customerName}! Requested time and date is not available. Please try other dates or times.`, 'error');
                    }
                } catch (error) {
                    console.error('Booking failed:', error);

                    // Show different messages based on error type
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        this.showStatus('Unable to connect to server. Please try again later.', 'error');
                    } else {
                        this.showStatus('Booking failed. Please try again or contact us directly.', 'error');
                    }
                } finally {
                    // Reset button
                    this.submitBtn.disabled = false;
                    this.submitBtn.innerHTML = 'Submit';
                }
            }

            showStatus(message, type) {
                this.welcomeMessage.innerHTML = message;
                this.welcomeMessage.className = `chat-message status-${type}`;
            }

            clearStatus() {
                this.welcomeMessage.innerHTML = 'Hello! Welcome to Planet Nine. Would you like to book an appointment?';
                this.welcomeMessage.className = 'chat-message';
            }
        }

        // Initialize chat widget when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ChatWidget();
        });
    </script>
</body>

</html>